<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>ByteDance Practices on Go Network Library | CloudWeGo</title><meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:title" content="ByteDance Practices on Go Network Library"><meta property="og:description" content="This article is excerpted from the ByteDance Architecture Practice series.
&ldquo;ByteDance Architecture Practice&rdquo; is a series of articles produced by the technical teams and experts from the ByteDance Architecture Team, to share the team&rsquo;s practical experience and lessons learnt from the development of infra-architecture, for the purpose of enhancing communication and growth of the developers.
As an important part of R&D system, RPC framework carries almost all service traffics. This paper will briefly introduce the design and practice of the ByteDance in-house developed network library &ndash; Netpoll, as well as the problems and solutions that arise during our practices."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2021/10/09/bytedance-practices-on-go-network-library/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-10-09T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-28T17:05:03+08:00"><meta property="og:site_name" content="CloudWeGo"><meta itemprop=name content="ByteDance Practices on Go Network Library"><meta itemprop=description content="This article is excerpted from the ByteDance Architecture Practice series.
&ldquo;ByteDance Architecture Practice&rdquo; is a series of articles produced by the technical teams and experts from the ByteDance Architecture Team, to share the team&rsquo;s practical experience and lessons learnt from the development of infra-architecture, for the purpose of enhancing communication and growth of the developers.
As an important part of R&D system, RPC framework carries almost all service traffics. This paper will briefly introduce the design and practice of the ByteDance in-house developed network library &ndash; Netpoll, as well as the problems and solutions that arise during our practices."><meta itemprop=datePublished content="2021-10-09T00:00:00+00:00"><meta itemprop=dateModified content="2022-03-28T17:05:03+08:00"><meta itemprop=wordCount content="2285"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="ByteDance Practices on Go Network Library"><meta name=twitter:description content="This article is excerpted from the ByteDance Architecture Practice series.
&ldquo;ByteDance Architecture Practice&rdquo; is a series of articles produced by the technical teams and experts from the ByteDance Architecture Team, to share the team&rsquo;s practical experience and lessons learnt from the development of infra-architecture, for the purpose of enhancing communication and growth of the developers.
As an important part of R&D system, RPC framework carries almost all service traffics. This paper will briefly introduce the design and practice of the ByteDance in-house developed network library &ndash; Netpoll, as well as the problems and solutions that arise during our practices."><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYWRQRLPRM')</script><link rel=preload href=/scss/main.min.21b6ee4b17f40145c62c9a4776d86cf33fbb76d5dab11a8168b90e2eeb0ff326.css as=style><link href=/scss/main.min.21b6ee4b17f40145c62c9a4776d86cf33fbb76d5dab11a8168b90e2eeb0ff326.css rel=stylesheet integrity><script src=https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYWRQRLPRM','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Documentation</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/docs/netpoll/>Netpoll</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2021/10/09/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8%E5%9C%A8-go-%E7%BD%91%E7%BB%9C%E5%BA%93%E4%B8%8A%E7%9A%84%E5%AE%9E%E8%B7%B5/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2021/10/09/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8%E5%9C%A8-go-%E7%BD%91%E7%BB%9C%E5%BA%93%E4%B8%8A%E7%9A%84%E5%AE%9E%E8%B7%B5/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ title="Docsy Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blognews-li><a href=/blog/news/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blognews><span>News</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220325an-article-to-learn-about-bytedance-microservices-middleware-cloudwego-li><a href=/blog/2022/03/25/an-article-to-learn-about-bytedance-microservices-middleware-cloudwego/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220325an-article-to-learn-about-bytedance-microservices-middleware-cloudwego><span>An Article to Learn About ByteDance Microservices Middleware CloudWeGo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211124getting-started-with-kitexs-practice-performance-testing-guide-li><a href=/blog/2021/11/24/getting-started-with-kitexs-practice-performance-testing-guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211124getting-started-with-kitexs-practice-performance-testing-guide><span>Getting Started With Kitex's Practice: Performance Testing Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20211009bytedance-practices-on-go-network-library-li><a href=/blog/2021/10/09/bytedance-practices-on-go-network-library/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20211009bytedance-practices-on-go-network-library><span class=td-sidebar-nav-active-item>ByteDance Practices on Go Network Library</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210923performance-optimization-on-kitex-li><a href=/blog/2021/09/23/performance-optimization-on-kitex/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210923performance-optimization-on-kitex><span>Performance Optimization on Kitex</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210913cloudwego-open-source-announcement-li><a href=/blog/2021/09/13/cloudwego-open-source-announcement/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210913cloudwego-open-source-announcement><span>CloudWeGo Open Source Announcement</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleases-li><a href=/blog/releases/ title="New Releases" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleases><span>Releases</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleaseskitex-li><a href=/blog/releases/kitex/ title="Kitex Release" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleaseskitex><span>Kitex</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220224kitex-release-v020-li><a href=/blog/2022/02/24/kitex-release-v0.2.0/ title="Kitex Release v0.2.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220224kitex-release-v020><span>Release v0.2.0</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220118kitex-release-v014-li><a href=/blog/2022/01/18/kitex-release-v0.1.4/ title="Kitex Release v0.1.4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220118kitex-release-v014><span>Release v0.1.4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211230kitex-release-v013-li><a href=/blog/2021/12/30/kitex-release-v0.1.3/ title="Kitex Release v0.1.3" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211230kitex-release-v013><span>Release v0.1.3</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211222kitex-release-v012-li><a href=/blog/2021/12/22/kitex-release-v0.1.2/ title="Kitex Release v0.1.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211222kitex-release-v012><span>Release v0.1.2</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211213kitex-release-v010-li><a href=/blog/2021/12/13/kitex-release-v0.1.0/ title="Kitex Release v0.1.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211213kitex-release-v010><span>Release v0.1.0</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211105kitex-release-v008-li><a href=/blog/2021/11/05/kitex-release-v0.0.8/ title="Kitex Release v0.0.8" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211105kitex-release-v008><span>Release v0.0.8</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210926kitex-release-v005-li><a href=/blog/2021/09/26/kitex-release-v0.0.5/ title="Kitex Release v0.0.5" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210926kitex-release-v005><span>Release v0.0.5</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210826kitex-release-v004-li><a href=/blog/2021/08/26/kitex-release-v0.0.4/ title="Kitex Release v0.0.4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210826kitex-release-v004><span>Release v0.0.4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210801kitex-release-v003-li><a href=/blog/2021/08/01/kitex-release-v0.0.3/ title="Kitex Release v0.0.3" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210801kitex-release-v003><span>Release v0.0.3</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210730kitex-release-v002-li><a href=/blog/2021/07/30/kitex-release-v0.0.2/ title="Kitex Release v0.0.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210730kitex-release-v002><span>Release v0.0.2</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210712kitex-release-v001-li><a href=/blog/2021/07/12/kitex-release-v0.0.1/ title="Kitex Release v0.0.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210712kitex-release-v001><span>Release v0.0.1</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleasesnetpoll-li><a href=/blog/releases/netpoll/ title="Netpoll Release" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleasesnetpoll><span>Netpoll</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220222netpoll-release-v020-li><a href=/blog/2022/02/22/netpoll-release-v0.2.0/ title="Netpoll Release v0.2.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220222netpoll-release-v020><span>Release v0.2.0</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211213netpoll-release-v012-li><a href=/blog/2021/12/13/netpoll-release-v0.1.2/ title="Netpoll Release v0.1.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211213netpoll-release-v012><span>Release v0.1.2</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211209netpoll-release-v011-li><a href=/blog/2021/12/09/netpoll-release-v0.1.1/ title="Netpoll Release v0.1.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211209netpoll-release-v011><span>Release v0.1.1</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211201netpoll-release-v010-li><a href=/blog/2021/12/01/netpoll-release-v0.1.0/ title="Netpoll Release v0.1.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211201netpoll-release-v010><span>Release v0.1.0</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210916netpoll-release-v004-li><a href=/blog/2021/09/16/netpoll-release-v0.0.4/ title="Netpoll Release v0.0.4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210916netpoll-release-v004><span>Release v0.0.4</span></a></li></ul></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/en/blog/news/bytedance_gonet_practice/index.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/en/blog/news/bytedance_gonet_practice/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?title=ByteDance%20Practices%20on%20Go%20Network%20Library" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cloudwego/kitex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#preface>Preface</a></li><li><a href=#design-of-the-new-network-library>Design of the New Network Library</a><ul><li><a href=#reactor---event-monitoring-and-the-core-of-scheduling>Reactor - Event Monitoring and the Core of Scheduling</a></li><li><a href=#server---mainreactor--subreactor-implementation>Server - MainReactor & SubReactor Implementation</a></li><li><a href=#client---shares-the-capability-of-reactor>Client - Shares the Capability of Reactor</a></li></ul></li><li><a href=#nocopy-buffer>Nocopy Buffer</a><ul><li><a href=#why-nocopy-buffer>Why Nocopy Buffer?</a></li><li><a href=#the-design-and-advantages-of-nocopy-buffer>The Design and Advantages of Nocopy Buffer</a></li></ul></li><li><a href=#connection-multiplexing>Connection Multiplexing</a></li><li><a href=#zerocopy>ZeroCopy</a></li><li><a href=#delay-caused-by-go-scheduling>Delay Caused By Go Scheduling</a></li><li><a href=#postscript>Postscript</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>ByteDance Practices on Go Network Library</h1><div class="td-byline mb-4">By <b><a href=https://github.com/Hchenn target=_blank>Hchen</a>, <a href=https://github.com/PureWhiteWu target=_blank>Pure White</a></b> |
<time datetime=2021-10-09 class=text-muted>Saturday, October 09, 2021</time></div><header class=article-meta></header><blockquote><p>This article is excerpted from the ByteDance Architecture Practice series.</p><p>&ldquo;ByteDance Architecture Practice&rdquo; is a series of articles produced by the technical teams and experts from the ByteDance Architecture Team, to share the team&rsquo;s practical experience and lessons learnt from the development of infra-architecture, for the purpose of enhancing communication and growth of the developers.</p><p>As an important part of R&D system, RPC framework carries almost all service traffics. This paper will briefly introduce the design and practice of the ByteDance in-house developed network library &ndash; Netpoll, as well as the problems and solutions that arise during our practices. This article can be used as a reference to help the tech-community&rsquo;s further practices and experiments.</p></blockquote><h2 id=preface>Preface</h2><p>As an important part of the R&D system, RPC framework carries almost all service traffics. As Golang is used more and more widely in ByteDance, the business has higher requirements on its framework. However, the &ldquo;Go net&rdquo; library cannot provide sufficient performance and control to support the business, notably inability to perceive the connection state, low utilization due to the large number of connections, and inability to control the number of goroutines. In order to take full control of the network layer, it&rsquo;s necessary to make some exploration prospectively, and finally empower the business. The Service Framework Team launched a new self-developed network library &ndash; &ldquo;Netpoll&rdquo; based on &ldquo;epoll&rdquo;, and developed a new-generation Golang framework &ndash; &ldquo;Kitex&rdquo; based on &ldquo;Netpoll&rdquo;.</p><p>Since there are many articles discussing the principles of &ldquo;epoll&rdquo;, this article will briefly introduce the design of &ldquo;Netpoll&rdquo; only. We&rsquo;ll then try to review some of our practices regarding &ldquo;Netpoll&rdquo;. Finally, we&rsquo;ll share a problem we encountered during our practices and how we solved it. In the meantime, we welcome more peers who are interested in Golang and Go framework to join us!</p><h2 id=design-of-the-new-network-library>Design of the New Network Library</h2><h3 id=reactor---event-monitoring-and-the-core-of-scheduling>Reactor - Event Monitoring and the Core of Scheduling</h3><p>The core of &ldquo;Netpoll&rdquo; is the event monitoring scheduler &ndash; &ldquo;Reactor&rdquo;, which uses &ldquo;epoll&rdquo; to monitor the &ldquo;File Descriptor (fd)&rdquo; of the connection and triggers the read, write and close events on the connection through the callback mechanism.<br><img src=/img/blog/bytedance_gonet_practice_img/reactor.png alt=image></p><h3 id=server---mainreactor--subreactor-implementation>Server - MainReactor & SubReactor Implementation</h3><p>Netpoll combines Reactors in a 1: N master-slave pattern:</p><ol><li>&ldquo;MainReactor&rdquo; mainly manages the &ldquo;Listener&rdquo;, and is responsible for monitoring ports and establishing new connections.</li><li>The &ldquo;SubReactor&rdquo; manages the &ldquo;Connection&rdquo;, listens all assigned connections, and submits all triggered events to the goroutine pool for processing.</li><li>&ldquo;Netpoll&rdquo; supports &ldquo;NoCopy RPC&rdquo; by introducing active memory management in I/O tasks and providing an &ldquo;NoCopy&rdquo; invocation interface to the upper layer.</li><li>Add a goroutine pool to centrally process I/O tasks, reduce the number of goroutines and scheduling overhead.<br></li></ol><p><img src=/img/blog/bytedance_gonet_practice_img/server_reactor.png alt=image></p><h3 id=client---shares-the-capability-of-reactor>Client - Shares the Capability of Reactor</h3><p>SubReactor is shared between the client and server. Netpoll implements &ldquo;Dialer&rdquo; and provides the function for establishing connections. On the client, similar to &ldquo;net.Conn&rdquo;, Netpoll provides underlying support for &ldquo;write -> wait read callback&rdquo;.<br><img src=/img/blog/bytedance_gonet_practice_img/client_reactor.png alt=image></p><h2 id=nocopy-buffer>Nocopy Buffer</h2><h3 id=why-nocopy-buffer>Why Nocopy Buffer?</h3><p>As mentioned earlier, the way epoll is triggered affects the design of I/O and buffer, which can be generally divided into two approaches:</p><ul><li><strong>Level Trigger (LT)</strong>. It is necessary to complete I/O actively after the event is triggered, and provides buffers directly to the upper code.</li><li><strong>Edge Trigger (ET)</strong>. You can choose to manage the event notification only (e.g. go net), with the upper layer code for I/O completion and buffers management.</li></ul><p>Both ways have their advantages and disadvantages. &ldquo;Netpoll&rdquo; adopts the first strategy, which has better timeliness and higher fault tolerance rate. Active I/O can centralize memory usage and management, provide nocopy operation, and reduce GC. In fact, some popular open-source network libraries, such as &ldquo;easygo&rdquo;, &ldquo;evio&rdquo;, &ldquo;gnet&rdquo;, etc. are also designed in this way.</p><p>However, using LT also brings another problem, namely the additional concurrency overhead caused by the underlying active I/O and the concurrent buffer operations by the upper code. For example, there are concurrent read and write when I/O read(data)/write(buffer) and the upper code reads the buffer, vice versa. In order to ensure data correctness and avoid lock contention, existing open-source network libraries usually adopt synchronous processing of buffer (&ldquo;easygo&rdquo;, &ldquo;evio&rdquo;) or provide a copy of buffer to the upper layer code (&ldquo;gnet&rdquo;), which are not suitable for business processing or have considerable copy overhead.</p><p>On the other hand, common buffer libraries such as &ldquo;bytes&rdquo;, &ldquo;bufio&rdquo;, and &ldquo;ringbuffer&rdquo; have problems such as &ldquo;growth&rdquo; requiring copy of data from the original array; capacity can only be expanded but can&rsquo;t be reduced; occupying a large amount of memory etc. Therefore, we hope to introduce a new form of buffer to solve the two problems above.</p><h3 id=the-design-and-advantages-of-nocopy-buffer>The Design and Advantages of Nocopy Buffer</h3><p>Nocopy Buffer is implemented based on linked-list of array. As shown in the figure below, we abstract []byte array into blocks and combine blocks into Nocopy Buffer in the form of a linked list. Meanwhile, reference counting mechanism, Nocopy API and object pool are introduced.<br><img src=/img/blog/bytedance_gonet_practice_img/buffer.png alt=image><br>Nocopy Buffer has the following advantages over some common buffer libraries like &ldquo;bytes&rdquo;, &ldquo;bufio&rdquo;, and &ldquo;ringbuffer&rdquo;:</p><ol><li>Read and write in parallel without lock, and supports stream read/write with nocopy<ul><li>Read and write operate the head pointer and tail pointer separately without interfering with each other.</li></ul></li><li>Efficient capacity expansion and reduction<ul><li>For capacity expansion, you can add new blocks directly after the tail pointer without copying the original array.</li><li>For capacity reduction, the head pointer directly releases the used block node to complete the capacity reduction. Each block has an independent reference count, and when the freed block is no longer referenced, the block node is actively reclaimed.</li></ul></li><li>Flexible slicing and splicing of buffer (the characteristic of linked list)<ul><li>Support arbitrary read slicing (nocopy), and the upper layer code can process data stream slicing in parallel with nocopy by reference counting GC, regardless of the lifecycle.</li><li>Support arbitrary splicing (nocopy). Buffer write supports splicing block after the tail pointer, without copy, and ensuring that data is written only once.</li></ul></li><li>Nocopy Buffer is pooled to reduce GC<ul><li>Treat each []byte array as a block node, and build an object pool to maintain free blocks, thus reuse blocks, reduce memory footprint and GC. Based on the Nocopy Buffer, we implemented Nocopy Thrift, so that the codec process allocates zero memory with zero copy.</li></ul></li></ol><h2 id=connection-multiplexing>Connection Multiplexing</h2><p>RPC calling is usually in the form of short connection or persistent connection pool, and each call is bound to one connection. Therefore, when the scale of upstream and downstream is large, the number of existing connections in the network increases in the speed of MxN, which brings huge scheduling pressure and computing overhead, and makes service governance difficult. Therefore, we want to introduce a mechanism for &ldquo;parallel processing of calls on a single persistent connection&rdquo; to reduce the number of connections in the network. This mechanism is called connection multiplexing.</p><p>There are some existing open-source connection multiplexing solutions. But they are limited by code level constraints. They all require copy buffer for data subcontracting and merging, resulting in poor performance. Nocopy Buffer, with its flexible slicing and splicing, well supports data subcontracting and merging with nocopy, making it possible to achieve high-performance connection multiplexing schemes.</p><p>The design of Netpoll-based connection multiplexing is shown in the figure below. We abstract the Nocopy Buffer(and its sharding) into virtual connections, so that the upper layer code retains the same calling experience as &ldquo;net.Conn&rdquo;. At the same time, the data on the real connection can be flexibly allocated to the virtual connection through protocol subcontracting in the underlying code. Or send virtual connection data through protocol encoding.<br><img src=/img/blog/bytedance_gonet_practice_img/client_server.png alt=image><br></p><p>The connection multiplexing scheme contains the following core elements:</p><ol><li>The virtual connection<ul><li>It is essentially a &ldquo;Nocopy Buffer&rdquo;, designed to replace real connections and avoid memory copy.</li><li>The upper-layer service logic/codec is executed on the virtual connection, and the upper-layer logic can be executed in parallel asynchronously and independently.</li></ul></li><li>Shared map<ul><li>Shared locking is introduced to reduce the lock intensity.</li><li>The Sequence ID is used to mark the request on the caller side and the shared lock is used to store the callback corresponding to the ID.</li><li>After receiving the response data, find the corresponding callback based on the sequence ID and execute it.</li></ul></li><li>Data subcontracting and encoding<ul><li>How to identify the complete request-response data package is the key to make the connection multiplexing scheme feasible, so the protocol needs to be introduced.</li><li>The &ldquo;Thrift Header Protocol&rdquo; is used to check the data package integrity through the message header, and sequence ids are used to mark the corresponding relations between request and response.</li></ul></li></ol><h2 id=zerocopy>ZeroCopy</h2><p>&ldquo;ZeroCopy&rdquo; refers to the ZeroCopy function provided by Linux. In the previous chapter, we discussed nocopy of the service layer. But as we know, when we call the &ldquo;sendmsg&rdquo; system-call to send a data package, actually there is still a copy of the data, and the overhead of such copies is considerable when the data packages are large. For example, when the data package has the size of 100M, we can see the following result:<br><img src=/img/blog/bytedance_gonet_practice_img/perf.png alt=image><br>The previous example is merely the overhead of tcp package sending. In our scenario, most services are connected to the &ldquo;Service Mesh&rdquo;. Therefore, there are three copies in a package sending: Service process to kernel, kernel to sidecar, sidecar to kernel. This makes the CPU usage caused by copying especially heavy for services demanding large package transactions, as shown in the following figure:<br><img src=/img/blog/bytedance_gonet_practice_img/service_mesh_copy.png alt=image><br>To solve this problem, we chose to use the ZeroCopy API provided by Linux (send is supported after 4.14; receive is supported after 5.4). But this introduces an additional engineering problem: the ZeroCopy send API is incompatible with the original call method and does not coexist well. Here&rsquo;s how ZeroCopy Send works: After the service process calls &ldquo;sendmsg&rdquo;, &ldquo;sendmsg&rdquo; records the address of the &ldquo;iovec&rdquo; and returns it immediately. In this case, the service process cannot release the memory, and needs to wait for the kernel to send a signal indicating that an &ldquo;iovec&rdquo; has been successfully sent before it can be released via &ldquo;epoll&rdquo;. Since we don&rsquo;t want to change the way the business side uses it, we need to provide a synchronous sending and receiving interface to the upper layer, so it is difficult to provide both ZeroCopy and non-Zerocopy abstraction based on the existing API. Since ZeroCopy has performance degradation in small package scenarios, this is not the default option.</p><p>Thus, the ByteDance Service Framework Team collaborated with the ByteDance Kernel Team. The Kernel Team provided the synchronous interface: when &ldquo;sendmsg&rdquo; is called, the kernel listens and intercepts the original kernel callback to the service, and doesn&rsquo;t let &ldquo;sendmsg&rdquo; return values until the callback is complete. This allows us to easily plug in &ldquo;ZeroCopy send&rdquo; without changing the original model. Meanwhile, the ByteDance Kernel Team also implements ZeroCopy based on Unix domain socket, which enables zero-copy communication between service processes and Mesh sidecar.</p><p>After using &ldquo;ZeroCopy send&rdquo;, we can see that the kernel is no longer occupied by copy through perf:<br><img src=/img/blog/bytedance_gonet_practice_img/perf2.png alt=image><br>In terms of CPU usage, ZeroCopy can save half the cpu of non-ZeroCopy in large package scenarios.</p><h2 id=delay-caused-by-go-scheduling>Delay Caused By Go Scheduling</h2><p>In our practice, we found that although our newly written &ldquo;Netpoll&rdquo; outperformed the &ldquo;Go net&rdquo; library in terms of avg delay, it was generally higher than the &ldquo;Go net&rdquo; library in terms of p99 and max delay, and the spikes would be more obvious, as shown in the following figure (Go 1.13, Netpoll + multiplexing in blue, Netpoll + persistent connection in green, Go net library + persistent connection in yellow):<br><img src=/img/blog/bytedance_gonet_practice_img/delay.png alt=image><br></p><p>We tried many ways to improve it, but the outcomes were unsatisfactory. Finally, we locate that the delay was not caused by the overhead of &ldquo;Netpoll&rdquo; itself, but by the scheduling of Go, for example:</p><ol><li>In &ldquo;Netpoll&rdquo;, the &ldquo;SubReactor&rdquo; itself is also a &ldquo;goroutine&rdquo;, which is affected by scheduling and cannot be guaranteed to be executed immediately after the &ldquo;EpollWait&rdquo; callback, so there would be a delay here.</li><li>At the same time, since the &ldquo;SubReactor&rdquo; used to handle I/O events and the &ldquo;MainReactor&rdquo; used to handle connection listening are &ldquo;goroutines&rdquo; themselves, it is actually impossible to ensure that these reactors can be executed in parallel under multi-kernel conditions. Even in the most extreme cases, these reactors may be under the same P, and eventually become sequential execution, which cannot take full advantage of multi-kernel;</li><li>After &ldquo;EpollWait callback&rdquo;, I/O events are processed serially in the &ldquo;SubReactor&rdquo;, so the last event may have a long tail problem.</li><li>In connection multiplexing scenarios, since each connection is bound to a &ldquo;SubReactor&rdquo;, the delay is entirely dependent on the scheduling of the &ldquo;SubReactor&rdquo;, resulting in more pronounced spikes. Because Go has specific improvements for the net library in runtime, the net library will not have the above situation. At the same time, the net library is also a &ldquo;goroutine-per-connection&rdquo; model, so it ensures that requests can be executed in parallel without interfering with each other.</li></ol><p>For the above problems, we have two solutions at present:</p><ol><li>Modify the Go runtime source code, register a callback in the Go runtime, call EpollWait each time, and pass the fd to the callback execution;</li><li>Work with the ByteDance Kernel Team to support simultaneous batch read/write of multiple connections to solve sequential problems. In addition, in our tests, Go 1.14 reduces the latency slightly lower and smoother, but the max QPS that can be achieved is lower. I hope our ideas can provide some references to peers in the industry who also encountered this problem.</li></ol><h2 id=postscript>Postscript</h2><p>We hope the above sharing can be helpful to the community. At the same time, we are accelerating the development of &ldquo;Netpoll&rdquo; and &ldquo;Kitex&rdquo; &ndash; a new framework based on &ldquo;Netpoll&rdquo;. You are welcome to join us and build Golang ecology together!</p><h2 id=reference>Reference</h2><ul><li><a href=http://man7.org/linux/man-pages/man7/epoll.7.html>http://man7.org/linux/man-pages/man7/epoll.7.html</a></li><li><a href=https://golang.org/src/runtime/proc.go>https://golang.org/src/runtime/proc.go</a></li><li><a href=https://github.com/panjf2000/gnet>https://github.com/panjf2000/gnet</a></li><li><a href=https://github.com/tidwall/evio>https://github.com/tidwall/evio</a></li></ul><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2021/09/23/performance-optimization-on-kitex/ aria-label="Previous - Performance Optimization on Kitex" class="btn btn-primary"><span class=mr-1>←</span> Previous</a></li><a href=/blog/2021/11/24/getting-started-with-kitexs-practice-performance-testing-guide/ aria-label="Next - Getting Started With Kitex's Practice: Performance Testing Guide" class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The CloudWeGo Authors All Rights Reserved</small><p class=mt-2><a class=cloudwego-link href=/about/>About CloudWeGo</a></p></div></div></div></footer></div><script src=https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.staticfile.org/bootstrap/4.6.0/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script></body></html>