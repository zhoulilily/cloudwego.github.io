<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Protocol extension | CloudWeGo</title><meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:title" content="Protocol extension"><meta property="og:description" content="Overview Thanks to the layered design of Hertz, in addition to the HTTP1/HTTP2 (to be open source) protocol server that comes with the Hertz framework by default, users can easily add/customize protocol processing logic that meets the needs of their own business scenarios according to their own needs.
In short, a server that implements the following interface can be added to Hertz as a custom extension server:
type Server interface { Serve(c context."><meta property="og:type" content="article"><meta property="og:url" content="/docs/hertz/tutorials/advanced-exten/protocol/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-06-27T16:57:21+08:00"><meta property="og:site_name" content="CloudWeGo"><meta itemprop=name content="Protocol extension"><meta itemprop=description content="Overview Thanks to the layered design of Hertz, in addition to the HTTP1/HTTP2 (to be open source) protocol server that comes with the Hertz framework by default, users can easily add/customize protocol processing logic that meets the needs of their own business scenarios according to their own needs.
In short, a server that implements the following interface can be added to Hertz as a custom extension server:
type Server interface { Serve(c context."><meta itemprop=dateModified content="2022-06-27T16:57:21+08:00"><meta itemprop=wordCount content="813"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Protocol extension"><meta name=twitter:description content="Overview Thanks to the layered design of Hertz, in addition to the HTTP1/HTTP2 (to be open source) protocol server that comes with the Hertz framework by default, users can easily add/customize protocol processing logic that meets the needs of their own business scenarios according to their own needs.
In short, a server that implements the following interface can be added to Hertz as a custom extension server:
type Server interface { Serve(c context."><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYWRQRLPRM')</script><link rel=preload href=/scss/main.min.74596076870d8ffa5db36c241dd9869dba338426a102ea7b739db8693ea21df8.css as=style><link href=/scss/main.min.74596076870d8ffa5db36c241dd9869dba338426a102ea7b739db8693ea21df8.css rel=stylesheet integrity><script src=https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYWRQRLPRM','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Documentation</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/docs/hertz/>Hertz</a>
<a class=dropdown-item href=/docs/netpoll/>Netpoll</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docshertz-li><a href=/docs/hertz/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertz><span>Hertz</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertzoverview-li><a href=/docs/hertz/overview/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertzoverview><span>Overview</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertzgetting-started-li><a href=/docs/hertz/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertzgetting-started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docshertztutorials-li><a href=/docs/hertz/tutorials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertztutorials><span>Tutorials</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsexample-li><a href=/docs/hertz/tutorials/example/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertztutorialsexample><span>Example code</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docshertztutorialsbasic-feature-li><a href=/docs/hertz/tutorials/basic-feature/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertztutorialsbasic-feature><span>Basic Feature</span></a><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsbasic-featurenetwork-lib-li><a href=/docs/hertz/tutorials/basic-feature/network-lib/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsbasic-featurenetwork-lib><span>Network Lib</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docshertztutorialsbasic-featuremiddleware-li><a href=/docs/hertz/tutorials/basic-feature/middleware/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertztutorialsbasic-featuremiddleware><span>Middleware Overview</span></a><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsbasic-featuremiddlewarecors-li><a href=/docs/hertz/tutorials/basic-feature/middleware/cors/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsbasic-featuremiddlewarecors><span>CORS</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsbasic-featuremiddlewarebasic-auth-li><a href=/docs/hertz/tutorials/basic-feature/middleware/basic-auth/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsbasic-featuremiddlewarebasic-auth><span>Basic Auth</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsbasic-featuremiddlewarejwt-li><a href=/docs/hertz/tutorials/basic-feature/middleware/jwt/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsbasic-featuremiddlewarejwt><span>JWT</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsbasic-featurebinding-and-validate-li><a href=/docs/hertz/tutorials/basic-feature/binding-and-validate/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsbasic-featurebinding-and-validate><span>Binding and validate</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsbasic-featurestream-li><a href=/docs/hertz/tutorials/basic-feature/stream/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsbasic-featurestream><span>Stream</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docshertztutorialsadvanced-extenprotocol-li><a href=/docs/hertz/tutorials/advanced-exten/protocol/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsadvanced-extenprotocol><span class=td-sidebar-nav-active-item>Protocol extension</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docshertztutorialsservice-governance-li><a href=/docs/hertz/tutorials/service-governance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertztutorialsservice-governance><span>Service Governance</span></a><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsservice-governancemonitoring-li><a href=/docs/hertz/tutorials/service-governance/monitoring/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsservice-governancemonitoring><span>Monitoring</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsservice-governancetracing-li><a href=/docs/hertz/tutorials/service-governance/tracing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsservice-governancetracing><span>Tracing</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docshertztutorialsframework-exten-li><a href=/docs/hertz/tutorials/framework-exten/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docshertztutorialsframework-exten><span>Framework Extension</span></a><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsframework-extenmonitor-li><a href=/docs/hertz/tutorials/framework-exten/monitor/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsframework-extenmonitor><span>Monitoring Extension</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docshertztutorialsframework-extenlog-li><a href=/docs/hertz/tutorials/framework-exten/log/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docshertztutorialsframework-extenlog><span>Logger Extension</span></a></li></ul></li></ul></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/en/docs/hertz/tutorials/advanced-exten/protocol.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/en/docs/hertz/tutorials/advanced-exten/protocol.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?title=Protocol%20extension" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cloudwego/kitex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#three-elements-of-protocol-layer-extension>Three elements of protocol layer extension</a><ul><li><a href=#protocol-layer-server-initialization>Protocol layer server initialization</a></li><li><a href=#interaction-with-upper-level-logic>Interaction with upper-level logic</a></li><li><a href=#registration-of-custom-protocol-server-into-hertz>Registration of custom protocol server into Hertz</a></li></ul></li><li><a href=#example>Example</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/hertz/>Hertz</a></li><li class=breadcrumb-item><a href=/docs/hertz/tutorials/>Tutorials</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/hertz/tutorials/advanced-exten/protocol/>Protocol extension</a></li></ol></nav><div class=td-content><h1>Protocol extension</h1><header class=article-meta></header><h2 id=overview>Overview</h2><p>Thanks to the layered design of Hertz, in addition to the HTTP1/HTTP2 (to be open source) protocol server that comes with the Hertz framework by default, users can easily add/customize protocol processing logic that meets the needs of their own business scenarios according to their own needs.</p><p>In short, a server that implements the following interface can be added to Hertz as a custom extension server:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Server</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>Serve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>conn</span> <span style=color:#000>network</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Conn</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=three-elements-of-protocol-layer-extension>Three elements of protocol layer extension</h2><h3 id=protocol-layer-server-initialization>Protocol layer server initialization</h3><p>Because the interface mentioned in the overview is actually a standard callback after the data is prepared at the network layer, the processing logic of our protocol layer will only be entered after a new request is established for a connection.</p><p>In this logic, we can customize the protocol parsing method, introduce business Handler execution, write data back and other standard behaviors of the protocol layer. This is also the core logic of our custom server.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>myServer</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>xxx</span>
    <span style=color:#000>xxx</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>myServer</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Serve</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>conn</span> <span style=color:#000>network</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Conn</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// protocol parsing
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// Go to the logic function of business registration (Route, Middleware, Handler...)
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// write data back
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Defining a protocol processing logic is as simple as that! However, the two steps of parsing the protocol and writing data back can be easily achieved through the <code>conn</code> interface provided in the input parameters, but how to go to the logical function of business registration?</p><h3 id=interaction-with-upper-level-logic>Interaction with upper-level logic</h3><p>A complete protocol must introduce business logic control (except for very few special situations), so how does the custom protocol in the Hertz framework realize this part of the ability? In fact, in the process of custom server initialization, the framework has naturally handed over this part of the capabilities to the custom protocol server.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ServerFactory</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>core</span> <span style=color:#000>Core</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span> <span style=color:#000>protocol</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Server</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Core is the core interface that promises to be provided for the protocol layer extensions
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Core</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#8f5902;font-style:italic>// IsRunning Check whether engine is running or not
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>IsRunning</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>bool</span>
   <span style=color:#8f5902;font-style:italic>// A RequestContext pool ready for protocol server impl
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>GetCtxPool</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Pool</span>
   <span style=color:#8f5902;font-style:italic>// Business logic entrance
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// After pre-read works, protocol server may call this method
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#8f5902;font-style:italic>// to introduce the middlewares and handlers
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>ServeHTTP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>app</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RequestContext</span><span style=color:#000;font-weight:700>)</span>
   <span style=color:#8f5902;font-style:italic>// GetTracer for tracing requirement
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>GetTracer</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>tracer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Controller</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>A custom server only needs to implement a protocol server generation factory according to the above interface. The Core in the parameters actually includes the introduction of upper-layer logic interaction and the specific implementation of other core application layer interfaces. When initializing a custom server, normally you only need to save the Core to the server. When you need to transfer to the business logic, you can guide the process to the application layer processing logic (Route, Middleware, Logic Handler) through the Core. When the business logic is executed and returned, further packets can be written back based on the business data.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>myServer</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>suite</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Core</span>
    <span style=color:#000>xxx</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>myServer</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Serve</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>conn</span> <span style=color:#000>network</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Conn</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// protocol parsing
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#000>Core</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServeHTTP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#8f5902;font-style:italic>// write data back
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>So far, a custom protocol layer server has been developed.</p><h3 id=registration-of-custom-protocol-server-into-hertz>Registration of custom protocol server into Hertz</h3><p>After completing the development of the server generation factory according to the above interface, it is very easy to load it into Hertz. Hertz&rsquo;s core engine naturally provides an interface for registering a custom protocol server:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>engine</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Engine</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>AddProtocol</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>protocol</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>factory</span> <span style=color:#000>suite</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServerFactory</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>engine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>protocolSuite</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>protocol</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>factory</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>It is only necessary to register the user&rsquo;s custom server generation factory with the engine according to the parameters specified by the interface. But it is worth noting that the protocol (string) registered here actually corresponds to the protocol negotiation key in ALPN (Application-Layer Protocol Negotiation), so if you want to access a custom protocol server through ALPN , directly specify the key as the corresponding key during ALPN negotiation. Currently, Hertz integrates an HTTP1 protocol server by default (the corresponding key is &ldquo;http/1.1&rdquo;). If you need to customize the HTTP1 protocol processing logic, you can directly specify the key as &ldquo;http/1.1&rdquo; within <code>AddProtocol</code> to overwrite.</p><h2 id=example>Example</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
   <span style=color:#4e9a06>&#34;bytes&#34;</span>
   <span style=color:#4e9a06>&#34;context&#34;</span>

   <span style=color:#4e9a06>&#34;github.com/cloudwego/hertz/pkg/app&#34;</span>
   <span style=color:#4e9a06>&#34;github.com/cloudwego/hertz/pkg/app/server&#34;</span>
   <span style=color:#4e9a06>&#34;github.com/cloudwego/hertz/pkg/common/errors&#34;</span>
   <span style=color:#4e9a06>&#34;github.com/cloudwego/hertz/pkg/common/hlog&#34;</span>
   <span style=color:#4e9a06>&#34;github.com/cloudwego/hertz/pkg/network&#34;</span>
   <span style=color:#4e9a06>&#34;github.com/cloudwego/hertz/pkg/protocol&#34;</span>
   <span style=color:#4e9a06>&#34;github.com/cloudwego/hertz/pkg/protocol/suite&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>myServer</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>suite</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Core</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#000>myServer</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Serve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>conn</span> <span style=color:#000>network</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Conn</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>firstThreeBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Peek</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span>
   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>bytes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Equal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>firstThreeBytes</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;GET&#34;</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>errors</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewPublic</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;not a GET method&#34;</span><span style=color:#000;font-weight:700>)</span>
   <span style=color:#000;font-weight:700>}</span>
   <span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetCtxPool</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Get</span><span style=color:#000;font-weight:700>().(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>app</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RequestContext</span><span style=color:#000;font-weight:700>)</span>
   <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetCtxPool</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Skip</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Len</span><span style=color:#000;font-weight:700>())</span>
      <span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Flush</span><span style=color:#000;font-weight:700>()</span>
   <span style=color:#000;font-weight:700>}()</span>
   <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Request</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetMethod</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;GET&#34;</span><span style=color:#000;font-weight:700>)</span>
   <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Request</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetRequestURI</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/test&#34;</span><span style=color:#000;font-weight:700>)</span>
   <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServeHTTP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
   <span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteBinary</span><span style=color:#000;font-weight:700>([]</span><span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;HTTP/1.1 200 OK\n&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
      <span style=color:#4e9a06>&#34;Server: hertz\n&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
      <span style=color:#4e9a06>&#34;Date: Sun, 29 May 2022 10:49:33 GMT\n&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
      <span style=color:#4e9a06>&#34;Content-Type: text/plain; charset=utf-8\n&#34;</span> <span style=color:#ce5c00;font-weight:700>+</span>
      <span style=color:#4e9a06>&#34;Content-Length: 2\n\nok\n&#34;</span><span style=color:#000;font-weight:700>))</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>

<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>serverFactory</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>serverFactory</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>core</span> <span style=color:#000>suite</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Core</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span> <span style=color:#000>protocol</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Server</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>myServer</span><span style=color:#000;font-weight:700>{</span>
      <span style=color:#000>core</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#000;font-weight:700>},</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>()</span>
   <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GET</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/test&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>app</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RequestContext</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000>hlog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;in handler&#34;</span><span style=color:#000;font-weight:700>)</span>
   <span style=color:#000;font-weight:700>})</span>
   <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddProtocol</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;http/1.1&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>serverFactory</span><span style=color:#000;font-weight:700>{})</span>
   <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Spin</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>Please tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>Please tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified
June 27, 2022
: <a href=https://github.com/cloudwego/cloudwego.github.io/commit/1a1233c29a3766571d86278c90857fc660a81337>docs: translate hertz/tutorials/framework-exten/advanced-exten/protocol (#224) (1a1233c)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The CloudWeGo Authors</small><p class="mt-2 text-white"><a class=cloudwego-link href=/about/ target=_blank rel=noopener>About</a>
|
<a class=cloudwego-link href=https://github.com/cloudwego/cloudwego.github.io/blob/main/LICENSE target=_blank rel=noopener>License</a></p></div></div></div></footer></div><script src=https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.staticfile.org/bootstrap/4.6.0/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script></body></html>