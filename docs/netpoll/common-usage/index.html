<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Common Usage | CloudWeGo</title><meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:title" content="Common Usage"><meta property="og:description" content="A leading practice for building enterprise cloud native middleware!"><meta property="og:type" content="website"><meta property="og:url" content="/docs/netpoll/common-usage/"><meta property="og:site_name" content="CloudWeGo"><meta itemprop=name content="Common Usage"><meta itemprop=description content="A leading practice for building enterprise cloud native middleware!"><meta name=twitter:card content="summary"><meta name=twitter:title content="Common Usage"><meta name=twitter:description content="A leading practice for building enterprise cloud native middleware!"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-QYWRQRLPRM')</script><link rel=preload href=/scss/main.min.f95524309453418871a413b9a587face83fc966617fd43915c481936076f7a1d.css as=style><link href=/scss/main.min.f95524309453418871a413b9a587face83fc966617fd43915c481936076f7a1d.css rel=stylesheet integrity><script src=https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-QYWRQRLPRM','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Documentation</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/docs/hertz/>Hertz</a>
<a class=dropdown-item href=/docs/netpoll/>Netpoll</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/netpoll/common-usage/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/netpoll/common-usage/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsnetpoll-li><a href=/docs/netpoll/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsnetpoll><span>Netpoll</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsnetpolloverview-li><a href=/docs/netpoll/overview/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsnetpolloverview><span>Overview</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsnetpollgetting-started-li><a href=/docs/netpoll/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsnetpollgetting-started><span>Getting Started</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsnetpollcommon-usage-li><a href=/docs/netpoll/common-usage/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__section" id=m-docsnetpollcommon-usage><span class=td-sidebar-nav-active-item>Common Usage</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsnetpollcaution-li><a href=/docs/netpoll/caution/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsnetpollcaution><span>Caution</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/en/docs/netpoll/Common%20Usage/_index.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/en/docs/netpoll/Common%20Usage/_index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?title=Common%20Usage" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cloudwego/kitex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#1-how-to-configure-the-number-of-pollers->1. How to configure the number of pollers ?</a></li><li><a href=#2-how-to-configure-pollers-connection-loadbalance->2. How to configure poller&rsquo;s connection loadbalance ?</a></li><li><a href=#3-how-to-configure-gopool->3. How to configure gopool ?</a></li><li><a href=#4-how-to-prepare-a-new-connection->4. How to prepare a new connection ?</a></li><li><a href=#5-how-to-configure-connection-timeout->5. How to configure connection timeout ?</a></li><li><a href=#6-how-to-configure-connection-read-event-callback->6. How to configure connection read event callback ?</a></li><li><a href=#7-how-to-configure-the-connection-close-callback->7. How to configure the connection close callback ?</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/netpoll/>Netpoll</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/netpoll/common-usage/>Common Usage</a></li></ol></nav><div class=td-content><h1>Common Usage</h1><header class=article-meta></header><h2 id=1-how-to-configure-the-number-of-pollers->1. How to configure the number of pollers ?</h2><p><code>NumLoops</code> represents the number of <code>epoll</code> created by [Netpoll][Netpoll], which has been automatically adjusted
according to the number of P (<code>runtime.GOMAXPROCS(0)</code>) by default, and users generally don&rsquo;t need to care.</p><p>But if your service has heavy I/O, you may need the following configuration:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;runtime&#34;</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetNumLoops</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GOMAXPROCS</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=2-how-to-configure-pollers-connection-loadbalance->2. How to configure poller&rsquo;s connection loadbalance ?</h2><p>When there are multiple pollers in Netpoll, the connections in the service process will be loadbalanced to
each poller.</p><p>The following strategies are supported now:</p><ol><li>Random<ul><li>The new connection will be assigned to a randomly picked poller.</li></ul></li><li>RoundRobin<ul><li>The new connection will be assigned to the poller in order.</li></ul></li></ol><p>Netpoll uses <code>RoundRobin</code> by default, and users can change it in the following ways:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetLoadBalance</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Random</span><span style=color:#000;font-weight:700>)</span>

	<span style=color:#8f5902;font-style:italic>// or
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetLoadBalance</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RoundRobin</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=3-how-to-configure-gopool->3. How to configure gopool ?</h2><p>Netpoll uses gopool as the goroutine pool by default to optimize the <code>stack growth</code> problem that
generally occurs in RPC services.</p><p>In the project gopool, it explains how to change its configuration, so won&rsquo;t repeat it here.</p><p>Of course, if your project does not have a <code>stack growth</code> problem, it is best to close gopool as follows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DisableGopool</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=4-how-to-prepare-a-new-connection->4. How to prepare a new connection ?</h2><p>There are different ways to prepare a new connection on the client and server.</p><ol><li>On the server side, <code>OnPrepare</code> is defined to prepare for the new connection, and it also supports returning
a <code>context</code>, which can be reused in subsequent business processing.
<code>WithOnPrepare</code> provides this registration. When the server accepts a new connection, it will automatically execute
the registered <code>OnPrepare</code> function to complete the preparation work. The example is as follows:</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;context&#34;</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// register OnPrepare
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>onPrepare</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnPrepare</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>prepare</span>
	<span style=color:#000>evl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewEventLoop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithOnPrepare</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>onPrepare</span><span style=color:#000;font-weight:700>))</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>prepare</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>connection</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Connection</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>prepare</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>...</span>
	<span style=color:#204a87;font-weight:700>return</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><ol start=2><li>On the client side, the connection preparation needs to be completed by the user. Generally speaking, the connection
created by <code>Dialer</code> can be controlled by the user, which is different from passively accepting the connection on the
server side. Therefore, the user not relying on the trigger, just prepare a new connection like this:</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;context&#34;</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DialConnection</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>network</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>address</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;dial netpoll connection failed&#34;</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>prepare</span> <span style=color:#000>here</span> <span style=color:#000>directly</span> <span style=color:#ce5c00;font-weight:700>...</span>
	<span style=color:#000>prepare</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>prepare</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>connection</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Connection</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>prepare</span> <span style=color:#000>connection</span> <span style=color:#ce5c00;font-weight:700>...</span>
	<span style=color:#204a87;font-weight:700>return</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=5-how-to-configure-connection-timeout->5. How to configure connection timeout ?</h2><p>Netpoll now supports two timeout configurations:</p><ol><li><code>Read Timeout</code><ul><li>In order to maintain the same operating style as <code>net.Conn</code>, <code>Connection.Reader</code> is also designed to block
reading. So provide <code>Read Timeout</code>.</li><li><code>Read Timeout</code> has no default value(wait infinitely), it can be configured via <code>Connection</code> or <code>EventLoop.Option</code>,
for example:</li></ul></li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>conn</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Connection</span>

	<span style=color:#8f5902;font-style:italic>// 1. setting by Connection
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetReadTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#000;font-weight:700>)</span>

	<span style=color:#8f5902;font-style:italic>// or
</span><span style=color:#8f5902;font-style:italic></span>
	<span style=color:#8f5902;font-style:italic>// 2. setting with Option
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewEventLoop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithReadTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#000;font-weight:700>))</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><ol start=2><li><code>Idle Timeout</code><ul><li><code>Idle Timeout</code> utilizes the <code>TCP KeepAlive</code> mechanism to kick out dead connections and reduce maintenance
overhead. When using Netpoll, there is generally no need to create and close connections frequently,
and idle connections have little effect. When the connection is inactive for a long time, in order to prevent dead
connection caused by suspended animation, hang of the opposite end, abnormal disconnection, etc., the connection
will be actively closed after the <code>Idle Timeout</code>.</li><li>The default minimum value of <code>Idle Timeout</code> is <code>10min</code>, which can be configured through <code>Connection</code> API
or <code>EventLoop.Option</code>, for example:</li></ul></li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>conn</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Connection</span>

	<span style=color:#8f5902;font-style:italic>// 1. setting by Connection
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetIdleTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#000;font-weight:700>)</span>

	<span style=color:#8f5902;font-style:italic>// or
</span><span style=color:#8f5902;font-style:italic></span>
	<span style=color:#8f5902;font-style:italic>// 2. setting with Option
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewEventLoop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithIdleTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>timeout</span><span style=color:#000;font-weight:700>))</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=6-how-to-configure-connection-read-event-callback->6. How to configure connection read event callback ?</h2><p><code>OnRequest</code> refers to the callback triggered by Netpoll when a read event occurs on the connection. On the
Server side, when creating the <code>EventLoop</code>, you can register an <code>OnRequest</code>, which will be triggered when each
connection data arrives and perform business processing. On the Client side, there is no <code>OnRequest</code> by default, and it
can be set via API when needed. E.g:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;context&#34;</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>onRequest</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnRequest</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>handler</span>

	<span style=color:#8f5902;font-style:italic>// 1. on server side
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>evl</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewEventLoop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>onRequest</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>opts</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>...</span>

	<span style=color:#8f5902;font-style:italic>// 2. on client side
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DialConnection</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>network</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>address</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>timeout</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetOnRequest</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>handler</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>handler</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>connection</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Connection</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000>handling</span> <span style=color:#ce5c00;font-weight:700>...</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=7-how-to-configure-the-connection-close-callback->7. How to configure the connection close callback ?</h2><p><code>CloseCallback</code> refers to the callback triggered by Netpoll when the connection is closed, which is used to
perform additional processing after the connection is closed.
Netpoll is able to perceive the connection status. When the connection is closed by peer or cleaned up by
self, it will actively trigger <code>CloseCallback</code> instead of returning an error on the next <code>Read</code> or <code>Write</code>(the way
of <code>net.Conn</code>).
<code>Connection</code> provides API for adding <code>CloseCallback</code>, callbacks that have been added cannot be removed, and multiple
callbacks are supported.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;github.com/cloudwego/netpoll&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>conn</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Connection</span>

	<span style=color:#8f5902;font-style:italic>// add close callback
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>cb</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CloseCallback</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callback</span>
	<span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddCloseCallback</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cb</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>callback</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>connection</span> <span style=color:#000>netpoll</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Connection</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><div class=section-index></div><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>Please tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>Please tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified
June 16, 2022
: <a href=https://github.com/cloudwego/cloudwego.github.io/commit/1d4721aa7b1bc875cc26e2c8fc0132599c72f351>docs(FAQ): add questions about kitex generator tool (#197) (1d4721a)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The CloudWeGo Authors</small><p class="mt-2 text-white"><a class=cloudwego-link href=/about/ target=_blank rel=noopener>About</a>
|
<a class=cloudwego-link href=https://github.com/cloudwego/cloudwego.github.io/blob/main/LICENSE target=_blank rel=noopener>License</a></p></div></div></div></footer></div><script src=https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.staticfile.org/bootstrap/4.6.0/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script></body></html>